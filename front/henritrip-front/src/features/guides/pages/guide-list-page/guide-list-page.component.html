<section class="page" @pageFadeIn>
  <header class="page-header" @slideDown>
    <div class="header-brand">
      <img src="/logo.png" alt="Henri Trip" class="brand-logo" />
      <div class="brand-text">
        <h1>Mes guides</h1>
        <p>Consultez les guides créés ou partagés avec vous.</p>
      </div>
    </div>

    <button type="button" class="btn btn-secondary" (click)="loadGuides()">
      Actualiser
    </button>
  </header>

  <form class="search-bar" (submit)="$event.preventDefault()">
    <input
      type="text"
      [ngModel]="searchTerm"
      (ngModelChange)="onSearchInput($event)"
      name="guideSearch"
      autocomplete="off"
      spellcheck="false"
      placeholder="Rechercher un guide, une destination..."
    />

    <button *ngIf="searchTerm" type="button" class="btn btn-ghost" (click)="clearSearch()">
      Effacer
    </button>
  </form>

  <div class="toolbar-row">
    <button type="button" class="btn btn-secondary" (click)="toggleFilters()">
      {{ showFilters ? 'Masquer les filtres' : 'Afficher les filtres' }}
      <span *ngIf="activeFiltersCount > 0">({{ activeFiltersCount }})</span>
    </button>

    <button
      *ngIf="activeFiltersCount > 0"
      type="button"
      class="btn btn-ghost"
      (click)="resetFilters()"
    >
      Réinitialiser les filtres
    </button>
  </div>

  <section *ngIf="showFilters" class="filters-panel" @panelReveal>
    <div class="filter-grid">
      <div class="filter-field">
        <label for="seasonFilter">Saison</label>
        <select
          id="seasonFilter"
          [(ngModel)]="selectedSeason"
          name="seasonFilter"
          (ngModelChange)="onFilterChange()"
        >
          <option value="">Toutes</option>
          <option *ngFor="let season of seasonOptions" [value]="season">
            {{ season }}
          </option>
        </select>
      </div>

      <div class="filter-field">
        <label for="mobilityFilter">Mobilité</label>
        <select
          id="mobilityFilter"
          [(ngModel)]="selectedMobility"
          name="mobilityFilter"
          (ngModelChange)="onFilterChange()"
        >
          <option value="">Toutes</option>
          <option *ngFor="let mobility of mobilityOptions" [value]="mobility">
            {{ mobility }}
          </option>
        </select>
      </div>

      <div class="filter-field">
        <label for="forWhoFilter">Pour qui</label>
        <select
          id="forWhoFilter"
          [(ngModel)]="selectedForWho"
          name="forWhoFilter"
          (ngModelChange)="onFilterChange()"
        >
          <option value="">Tous</option>
          <option *ngFor="let target of forWhoOptions" [value]="target">
            {{ target }}
          </option>
        </select>
      </div>

      <div class="filter-field">
        <label for="daysFilter">Nb jours minimum</label>
        <select
          id="daysFilter"
          [ngModel]="minDaysCount"
          name="daysFilter"
          (ngModelChange)="minDaysCount = $event === '' ? null : +$event; onFilterChange()"
        >
          <option value="">Tous</option>
          <option [value]="1">1+</option>
          <option [value]="2">2+</option>
          <option [value]="3">3+</option>
          <option [value]="4">4+</option>
          <option [value]="5">5+</option>
        </select>
      </div>
    </div>
  </section>

  <div *ngIf="isOffline" class="state error" @alertFade>
    Mode hors ligne. Synchronisation automatique au retour de la connexion.
  </div>

  <div *ngIf="loading" class="state" @fadeUp>Chargement des guides...</div>

  <div *ngIf="!loading && errorMessage" class="state error" @alertFade>
    {{ errorMessage }}
  </div>

  <div *ngIf="!loading && !errorMessage && !filteredGuides.length" class="state" @fadeUp>
    Aucun guide trouvé.
  </div>

  <div *ngIf="!loading && filteredGuides.length" class="grid" @listStagger>
    <a
      class="card"
      *ngFor="let guide of filteredGuides; trackBy: trackByGuideId"
      [routerLink]="['/guides', guide.id]"
    >
      <div class="cover" [class.placeholder]="!guide.coverImageUrl">
        <img *ngIf="guide.coverImageUrl" [src]="guide.coverImageUrl" [alt]="guide.title" />
        <span *ngIf="!guide.coverImageUrl">Guide</span>
      </div>

      <div class="card-body">
        <h2>{{ guide.title }}</h2>
        <p class="destination" *ngIf="guide.destination">{{ guide.destination }}</p>
        <p class="description">{{ guide.description }}</p>

        <div class="meta">
          <span>{{ guide.daysCount ?? 0 }} jour(s)</span>
          <span *ngIf="guide.mobility">{{ guide.mobility }}</span>
          <span *ngIf="guide.season">{{ guide.season }}</span>
          <span *ngIf="guide.forWho">{{ guide.forWho }}</span>
        </div>
      </div>
    </a>
  </div>
</section>
